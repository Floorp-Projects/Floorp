name: "(P) ⚠️ Package and Publish Release"

on:
  workflow_dispatch:
    inputs:
      runtime_windows_artifact_workflow_run_id:
        description: "The workflow run ID for the Windows runtime artifact"
        required: false
        type: string
      runtime_linux_artifact_workflow_run_id:
        description: "The workflow run ID for the Linux runtime artifact"
        required: false
        type: string
      runtime_mac_artifact_workflow_run_id:
        description: "The workflow run ID for the macOS runtime artifact"
        required: false
        type: string
      runtime_linux_aarch64_artifact_workflow_run_id:
        description: "The workflow run ID for the Linux aarch64 runtime artifact"
        required: false
        type: string
permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check if version already exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(jq -r .version package.json)
          if gh release view "v$VERSION"; then
            echo "Version v$VERSION already exists. Exiting..."
            exit 1
          fi

  package-windows:
    needs: check-version
    uses: ./.github/workflows/package.yml
    with:
      platform: Windows-x64
      runtime_artifact_workflow_run_id: ${{ inputs.runtime_windows_artifact_workflow_run_id }}
    secrets: inherit

  package-linux:
    needs: check-version
    uses: ./.github/workflows/package.yml
    with:
      platform: Linux-x64
      runtime_artifact_workflow_run_id: ${{ inputs.runtime_linux_artifact_workflow_run_id }}
    secrets: inherit

  package-macos:
    needs: check-version
    uses: ./.github/workflows/package.yml
    with:
      platform: macOS-x64
      runtime_artifact_workflow_run_id: ${{ inputs.runtime_mac_artifact_workflow_run_id }}
    secrets: inherit

  package-linux-aarch64:
    needs: check-version
    uses: ./.github/workflows/package.yml
    with:
      platform: Linux-aarch64
      runtime_artifact_workflow_run_id: ${{ inputs.runtime_linux_aarch64_artifact_workflow_run_id }}
    secrets: inherit

  publishs:
    needs:
      [package-windows, package-linux, package-macos, package-linux-aarch64]
    uses: ./.github/workflows/publish_release.yml
    with:
      publish_ppa: true
      linux_deb_run_id: ${{ needs.package-linux.outputs.run_id }}
    secrets: inherit
