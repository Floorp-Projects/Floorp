name: Pull upstream

on: workflow_dispatch

jobs:
  pull-upstream:
    name: Pull upstream
    
    runs-on: ubuntu-22.04
    
    steps:
    - name: Setup
      run: |
        export DATE_STR=`date +"%Y%m%d%I%M%S"`
        echo "DATE_STR=$DATE_STR" >> $GITHUB_ENV
        pip install mercurial

    - uses: actions/checkout@v3
      name: Clone ðŸ§¬

    - name: Setup git-cinnabar
      run: |
        cd ~
        git clone https://github.com/glandium/git-cinnabar
        cd git-cinnabar
        git checkout 0.5.11
        export PATH=~/git-cinnabar:$PATH
        cd ~
        git cinnabar download

    - name: Clone mozilla-unified ðŸ§¬
      run: |
        export PATH=~/git-cinnabar:$PATH
        git clone hg::https://hg.mozilla.org/mozilla-unified
        cd mozilla-unified
        git checkout -b upstream-esr102-${DATE_STR} origin/bookmarks/esr102

    - name: Fetch Floorp ðŸ§¬
      run: |
        export PATH=~/git-cinnabar:$PATH
        cd mozilla-unified
        git remote add floorp https://github.com/${{ github.repository }}
        git fetch floorp

    - name: Push
      run: |
        cd mozilla-unified
        git config user.name github-actions
        git config user.email github-actions@github.com
        git push floorp upstream-esr102-${DATE_STR}
