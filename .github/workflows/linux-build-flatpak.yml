# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# Please write our copyright if you use this file.
# ¬© 2023 Floorp Projects & Contributors

name: Flatpak Build

on:
  workflow_dispatch:
    inputs:
      tarball-url-x86-64:
        type: string
        required: true
        description: URL of tarball (x86_64)
      tarball-url-aarch64:
        type: string
        required: true
        description: URL of tarball (aarch64)

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: ["x86_64", "aarch64"]

    env:
      FLATPAK_ARCH: ${{ matrix.arch }}

    steps:
    - name: Generate org.mozilla.firefox.BaseApp version hash (aarch64)
      if: matrix.arch == 'aarch64'
      run: |
        sudo apt update
        sudo apt install jq
        mkdir vh_tmp
        cd vh_tmp
        curl -f -o api-result.json "https://api.github.com/repos/flathub/org.mozilla.firefox.BaseApp" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"
        FIREFOX_BASEAPP_VERSION_HASH=$(cat api-result.json | jq -r ".updated_at" | sha256sum | awk '{ print $1 }')
        echo $FIREFOX_BASEAPP_VERSION_HASH
        echo "FIREFOX_BASEAPP_VERSION_HASH=$FIREFOX_BASEAPP_VERSION_HASH" >> $GITHUB_ENV
        cd ..
        rm -r vh_tmp

    - name: org.mozilla.firefox.BaseApp build cache (aarch64)
      if: matrix.arch == 'aarch64'
      uses: actions/cache@v3
      with:
        path: ./org.mozilla.firefox.BaseApp/build-dir/files
        key: flatpak-firefox-baseapp-aarch64-${{ env.FIREFOX_BASEAPP_VERSION_HASH }}

    - name: Package üì¶
      run: |
        sudo apt update
        sudo apt install flatpak aria2 fakeroot

        mkdir ./flatpak_build
        mkdir ./flatpak_build/tmp
        mkdir ./flatpak_build/public

        sudo flatpak remote-add --if-not-exists --from flathub https://dl.flathub.org/repo/flathub.flatpakrepo
        flatpak remote-add --user --if-not-exists --from flathub https://dl.flathub.org/repo/flathub.flatpakrepo

        if [[ "$FLATPAK_ARCH" == "x86_64" ]]; then
          aria2c '${{ inputs.tarball-url-x86-64 }}' -o floorp.tar.bz2
          flatpak install --user -y flathub org.mozilla.firefox.BaseApp//22.08 --no-deps
          cp -r ~/.local/share/flatpak/app/org.mozilla.firefox.BaseApp/current/active/files/* ./flatpak_build/tmp/
        elif [[ "$FLATPAK_ARCH" == "aarch64" ]]; then
          aria2c '${{ inputs.tarball-url-aarch64 }}' -o floorp.tar.bz2

          if [ ! -d ./org.mozilla.firefox.BaseApp/build-dir/files ]; then
            sudo apt install qemu-system-arm qemu-user-static flatpak-builder

            sudo flatpak install -y flathub org.freedesktop.Sdk/aarch64/22.08
            sudo flatpak install -y flathub org.freedesktop.Platform/aarch64/22.08

            git clone https://github.com/flathub/org.mozilla.firefox.BaseApp --depth 1 --branch branch/22.08 --recursive
            cd org.mozilla.firefox.BaseApp
            flatpak-builder --arch=aarch64 build-dir org.mozilla.firefox.BaseApp.json
            cd ..
          fi
          cp -r ./org.mozilla.firefox.BaseApp/build-dir/files/* ./flatpak_build/tmp/
        fi

        rm ./flatpak_build/tmp/manifest.json
        mkdir -p ./flatpak_build/tmp/lib/ffmpeg
        ls ./flatpak_build/tmp

        tar -xvf ./floorp.tar.bz2 -C ./flatpak_build/tmp/lib
        ls ./flatpak_build/tmp/lib/floorp

        launch_script=(
        '#!/bin/bash'
        'export TMPDIR=$XDG_CACHE_HOME/tmp'
        'exec /app/lib/floorp/floorp "$@"'
        )
        for line in "${launch_script[@]}" ; do echo $line >> ./flatpak_build/tmp/bin/floorp ; done
        chmod +x ./flatpak_build/tmp/bin/floorp
        
        mkdir -p ./flatpak_build/tmp/lib/floorp/distribution
        distribution_file=(
        '{'
        '  "policies": {'
        '    "DisableAppUpdate": true'
        '  }'
        '}'
        )
        for line in "${distribution_file[@]}" ; do echo $line >> ./flatpak_build/tmp/lib/floorp/distribution/policies.json ; done

        mkdir -p ./flatpak_build/tmp/share/applications
        aria2c 'https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}/.github/flatpak-one.ablaze.floorp.desktop' -o ./flatpak_build/tmp/share/applications/one.ablaze.floorp.desktop

        for size in 16 32 48 64 128; do
          mkdir -p "./flatpak_build/tmp/share/icons/hicolor/${size}x${size}/apps"
          cp "./flatpak_build/tmp/lib/floorp/browser/chrome/icons/default/default${size}.png" "./flatpak_build/tmp/share/icons/hicolor/${size}x${size}/apps/one.ablaze.floorp.png"
        done

        cd ./flatpak_build/tmp
        fakeroot tar -Jcf flatpak-base.tar.xz *
        mv flatpak-base.tar.xz ../public/
        cd ../..
        ls ./flatpak_build/public

    - name: Publish üéÅ
      uses: actions/upload-artifact@v3
      with:
        name: floorp-linux-flatpak-${{ matrix.arch }}
        path: flatpak_build/public

  screenshot:
    runs-on: ubuntu-22.04
    needs: build

    steps:
    - name: Take a screenshot üì∏
      run: |
        curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.PAT_KEY }}"\
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/Floorp-Projects/About-Floorp-Projects/actions/workflows/update-flathub-picture.yml/dispatches \
          -d '{"ref":"main"}'
