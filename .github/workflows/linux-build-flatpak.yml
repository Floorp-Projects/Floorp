name: Flatpak Build

on:
  workflow_dispatch:
    inputs:
      tarball-url:
        type: string
        required: true
        description: URL of tarball

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Package üì¶
      run: |
        sudo apt install flatpak aria2 fakeroot

        aria2c '${{ inputs.tarball-url }}' -o floorp.tar.bz2

        flatpak remote-add --user --if-not-exists --from flathub https://dl.flathub.org/repo/flathub.flatpakrepo
        flatpak install --user -y flathub org.mozilla.firefox.BaseApp//22.08 --no-deps
        
        mkdir ./flatpak_build
        mkdir ./flatpak_build/tmp
        mkdir ./flatpak_build/public

        cp -r ~/.local/share/flatpak/app/org.mozilla.firefox.BaseApp/current/active/files/* ./flatpak_build/tmp/
        rm ./flatpak_build/tmp/manifest.json
        mkdir -p ./flatpak_build/tmp/lib/ffmpeg
        ls ./flatpak_build/tmp

        tar -xvf ./floorp.tar.bz2 -C ./flatpak_build/tmp/lib
        ls ./flatpak_build/tmp/lib/floorp

        launch_script=(
        '#!/bin/bash'
        'export TMPDIR=$XDG_CACHE_HOME/tmp'
        'exec /app/lib/floorp/floorp "$@"'
        )
        for line in "${launch_script[@]}" ; do echo $line >> ./flatpak_build/tmp/bin/floorp ; done
        chmod +x ./flatpak_build/tmp/bin/floorp
        
        mkdir -p ./flatpak_build/tmp/lib/floorp/distribution
        distribution_file=(
        '{'
        '  "policies": {'
        '    "DisableAppUpdate": true'
        '  }'
        '}'
        )
        for line in "${distribution_file[@]}" ; do echo $line >> ./flatpak_build/tmp/lib/floorp/distribution/policies.json ; done

        mkdir -p ./flatpak_build/tmp/share/applications
        aria2c 'https://raw.githubusercontent.com/Floorp-Projects/Floorp/${{ github.ref_name }}/.github/flatpak-one.ablaze.floorp.desktop' -o ./flatpak_build/tmp/share/applications/one.ablaze.floorp.desktop

        for size in 16 32 48 64 128; do
          mkdir -p "./flatpak_build/tmp/share/icons/hicolor/${size}x${size}/apps"
          cp "./flatpak_build/tmp/lib/floorp/browser/chrome/icons/default/default${size}.png" "./flatpak_build/tmp/share/icons/hicolor/${size}x${size}/apps/one.ablaze.floorp.png"
        done

        cd ./flatpak_build/tmp
        fakeroot tar -Jcf flatpak-base.tar.xz *
        mv flatpak-base.tar.xz ../public/
        cd ../..
        ls ./flatpak_build/public

    - name: Publish üéÅ
      uses: actions/upload-artifact@v3
      with:
        name: floorp-linux-flatpak-x64
        path: flatpak_build/public

    - name: Take a screenshot üì∏
      run: |
        curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.PAT_KEY }}"\
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/Floorp-Projects/About-Floorp-Projects/actions/workflows/update-flathub-picture.yml/dispatches \
          -d '{"ref":"main"}'
