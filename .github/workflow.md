# Floorp Browser Work Flow

Use: Windows 10 64bit or Windows 11 | Ubuntu 20.04 (Linux Mint)

## Setup Floorp build environment (Windows)

Install Git
```
https://gitforwindows.org
```

Install Visual Studio Build Tool 2022
```
https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2022
```

Install mozilla build tool
```
https://ftp.mozilla.org/pub/mozilla.org/mozilla/libraries/win32/MozillaBuildSetup-Latest.exe
```

Note: Visual Studio Code is recommended as a development tool.
```
https://code.visualstudio.com
```

---
## Setup Floorp build environment (Linux)

Install Git tool
```
sudo apt install git
```
Install Python tools
```
sudo apt-get install curl python3 python3-dev python3-pip
```

----
## Clone & Bootstrap source code

Clone Floorp Browser repo

```
git clone https://github.com/Floorp-Projects/Floorp/.git

NOTICE: If you just build and aren't interested in other branches, fast cloning is possible

USE: git clone --branch [BRANCH] --depth 200 https://github.com/Floorp-Projects/Floorp.git

```
BootStrap source code

`NOTICE: Please Select 2. After that, all n is OK`
```
cd Floorp
./mach bootstrap
```
----

## Add mozconfig
`Create an unextended "mozconfig" file in the Floorp clone directory`

Write the following
```
(Windows)
ac_add_options --with-app-name=floorp
ac_add_options --with-app-basename=Floorp
ac_add_options --disable-maintenance-service
ac_add_options --disable-crashreporter
ac_add_options --disable-bootstrap
ac_add_options --disable-tests
ac_add_options --disable-debug
ac_add_options --disable-verify-mar
ac_add_options --enable-proxy-bypass-protection
ac_add_options --disable-parental-controls
ac_add_options --disable-dmd
ac_add_options --disable-geckodriver
ac_add_options --disable-jprof
ac_add_options --enable-lto
ac_add_options --enable-update-channel=release
ac_add_options --with-branding=browser/branding/official
ac_add_options --disable-default-browser-agent
ac_add_options --with-google-safebrowsing-api-keyfile={Floorp 用の Google API のファイルパス}
MOZ_REQUIRE_SIGNING=
MOZ_TELEMETRY_REPORTING=
MOZ_DATA_REPORTING=
MOZ_STUB_INSTALLER=1


(Linux)
ac_add_options --with-app-basename=Floorp
ac_add_options --with-app-name=floorp
ac_add_options --with-branding=browser/branding/official
ac_add_options --with-l10n-base=/home/surapunoyousei/mozilla-source/l10n-central/l10n-central
ac_add_options --disable-crashreporter
ac_add_options --disable-bootstrap
ac_add_options --disable-tests
ac_add_options --disable-debug
ac_add_options --disable-verify-mar
ac_add_options --enable-proxy-bypass-protection
ac_add_options --with-google-safebrowsing-api-keyfile={Floorp 用の Google API のファイルパス}
ac_add_options --with-mozilla-api-keyfile{ファイルパス}
ac_add_options --with-google-location-service-api-keyfile={ファイルパス}
ac_add_options --enable-update-channel=release
MOZ_REQUIRE_SIGNING=
MOZ_TELEMETRY_REPORTING=
MOZ_DATA_REPORTING=

```
ac_add_options --with-google-safebrowsing-api-keyfile=C:/gapi/gapi.data
ac_add_options --with-l10n-base=E:/l10n-central/l10n-central

If you have cloned l10n, you need to set the following: `ac_add_options --with-l10n-base=/path/to/l10n-central`

Also, to include the Google Safe Browsing API:ac_add_options `--with-google-safebrowsing-api-keyfile=/path/to/apifile/`

----

## Build Floorp Browser
`Note: This takes at least 30 minutes. It takes up to 4 hours.`

Build Floorp Browser

```
cd /path/to/Floorp/repo/

./mach build
```

----

## Run test

```
cd /path/to/Floorp/repo/

./mach run
```
-----

## Package & Make installer

```
cd /path/to/Floorp/repo/

Make packed Floorp
./mach package

Make multi language installer & bin
export MOZ_CHROME_MULTILOCALE="ar cs da de el en-GB en-US es-ES es-MX fr hu id it ja ko lt nl nn-NO pl pt-BR pt-PT ru sv-SE th vi zh-CN zh-TW"

for AB_CD in $MOZ_CHROME_MULTILOCALE; do    ./mach build chrome-$AB_CD; done

AB_CD=multi ./mach package
```
`The installer is now generated in (Windows) %obj-dir%/dist/install/sea/` or `(Linux) %obj-dir%/dist/`

----

## Release Installer (Linux Only)

Floorp's stub installer points to the latest release of GitHub exe. You should refer to ``browser/branding/[branding]/branding.nsi`` as it varies from branding to branding.

Also currently refer to:
```https://github.com/Floorp-Projects/Floorp/releases/latest/download/floorp-<Display Verison>.win64.installer.exe```

First, rename the full installer generated by the multi-language build

```
floorp-102.0.en-US.win64.installer.exe → floorp.win64.installer.exe
```
`NOTE: It is possible to include a version, but to prevent mistakes, we intentionally specify that the exe should not include the version.`

Publish `floorp.win64.installer.exe` to https://github.com/Floorp-Projects/Floorp/releases

stub insatller uses the latest version of the URL to detect the full installer and does not need to be raised.

----

## Release Update (Windows Only)

`NOTE: The updater is automatic from version 10. This added some effort, but the Japanese version is no longer needed. Also, this work is supposed to be done after a multi-language build.  If you don't have a multi-language build, you'll run a fatal issue with the update`

First generate a mar file. See the link below for this file.
```
https://firefox-source-docs.mozilla.org/taskcluster/setting-up-an-update-server.html#building-a-mar
```

You can easily create a mar file. You need the following command
```
cd /path/to/Floorp/repo/

touch "obj-x86_64-pc-mingw32/dist/floorp/precomplete"

MAR="obj-x86_64-pc-mingw32/dist/host/bin/mar.exe" MOZ_PRODUCT_VERSION=<Write version of Floorp> MAR_CHANNEL_ID=release ./tools/update-packaging/make_full_update.sh /<MAR>/<output>/<path> "obj-x86_64-pc-mingw32/dist/floorp"
```

### make xml update file

`NOTE: This file is used by Floorp to determine if there is an update. That is, if this file fails, no updates will be released.`

Example: The file looks like this
```
<?xml version="1.0" encoding="UTF-8"?>
<updates>
    <update type="minor" displayVersion="10.0.0b16" appVersion="102.0" platformVersion="102.0" buildID="20220611234516" detailsURL="https://blog.ablaze.one/category/ablaze/ablaze-project/floorp/">
        <patch type="complete" URL="https://github.com/Floorp-Projects/Floorp/releases/download/10.0.0b14/output.mar"  size="64144579"/>
    </update>
</updates>
```

Display verison refers to the latest version. Must match the version of Floorp you built

appVersion and platformVerison is the version of Firefox.

You can find the build ID by looking for browser.startup.homepage_override in about: config during ./mach run.

size is the size of the mar file. If you upload the mar file to GitHub, you can check the size with the following command
```
curl -v https://api.github.com/repos/Floorp-Projects/Floorp/releases/latest
```
Place the completed xml in 

Windows：https: //repo.ablaze.one/data/floorp/10.0.0/WINNT/update.xml
macOS：https: //repo.ablaze.one/data/floorp/10.0.0/Darwin/update.xml

This completes the release
