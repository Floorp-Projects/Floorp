## Beta ブランチ運用（長寿命 beta ブランチ）

このドキュメントは、Floorp プロジェクトにおける「長寿命の `beta` ブランチ」を使った運用ルールを定義します。
目的は運用を統一し、Daylight（Beta） の自動リリースと 3 週間サイクルの main マージを安全に運用することです。

### 概要

- ブランチ名: `beta`（常に最新のベータ開発状態を保持）
- 主な運用: Feature ブランチは `beta` にマージされ、3 週間ごとのマージウィンドウで `beta` の状態を `main` に取り込みます。
- 自動リリース: `beta` の最新コミットを 3 日ごとに Daylight ブランドとして自動ビルド・配布します（条件付き）。

### 目的とメリット

- シンプルなブランチモデルにより運用コストを下げる
- 常に一つの Beta ブランチを参照できるため、デプロイや検証が容易

### 運用ルール（要点）

1. Feature ブランチを作成: `feature/<short-desc>`。
2. PR を作成して `beta` に対してレビューと CI を実施。
3. PR マージ条件:
   - 必須 CI（lint, unit tests, build-smoke）をパス
   - 最低 1 人のレビュー承認（チーム合意で2人に変更可）
   - 重大な未解決の blocker がないこと
4. `beta` から `main` への取り込みは 3 週間サイクルで実行。取り込みはリリース責任者が行う。

### ブランチ保護ルール（推奨）

- `beta` と `main` に対して保護ルールを設定する。
  - 強制的な CI 通過
  - 必要なレビュー数 1-2
  - 管理者による強制マージを制限

### 3 週間サイクルの扱い

- サイクル開始: 目標を定め、`beta` に日常の開発を反映する。
- 中間: 機能開発とバグ修正を継続。
- 最終週（安定化）: 重大バグの修正を優先し、後方互換を維持。
- マージ: サイクル最終日に `beta` を `main` にマージ（マージ戦略はチーム合意に従う：merge commit / squash / rebase）。

### 自動 Daylight リリース（3 日ごと）

- トリガ: スケジュール（cron）により 3 日毎にワークフローを実行する。
  - GitHub Actions の cron 例（UTC）: `0 2 */3 * *`（UTC 02:00、3 日毎）
- 条件:
  - 直近のリリース以降に `beta` に変更がある場合のみ実行する（差分チェック）
  - `beta` が「コードフリーズ」フラグを持つ場合は自動リリースを抑止する（CI 環境変数 or ブランチラベルで制御）
- 成果物: ビルド（例: macOS DMG）、署名済みバイナリ、Windows のみ署名なし、生成されたリリースノート

### リリースノートとバージョニング

- `beta` の自動リリースにはプレリリース表記を付与する（例: `1.2.0-daylight.20251029`）。
- リリースノートは PR のマージ履歴（title, label）から自動生成するツール（例: release-drafter）を推奨。

### CI 要件（`beta` へのマージ時）

- PR レベルで最低限実行する: lint, unit tests, build-smoke
- `beta` へマージされたコミットは別のワークフローでフルビルドと統合テストを実行

### コードフリーズと自動リリース停止

- サイクル末期および重大な調査期間中は、`beta` に `release:hold` ラベルまたは `BETA_FREEZE=true` のような環境フラグを設定することで、自動リリースを一時停止できる。

### Hotfix（緊急修正）の扱い

- 安定版（main）のみに影響する緊急修正は `hotfix/<id>` を作り、main へ直行 → main の hotfix を `beta` に逆マージして整合性を保つ。

### ロールバックとアーカイブ

- 各 Daylight リリースはタグ付けし、少なくとも直近 5 リリースのアーティファクトを保存する。
- 問題発生時は以前のタグを再配布してロールバックを行う。重大な場合は自動更新を一時停止する。

### モニタリングと通知

- リリース後は自動で通知（Slack, email）を送る。
- クラッシュレポートやクラッシュ率の急増を監視し、閾値越えでアラート出す。

### 権限と責任

- リリース責任者: サイクルの最終マージと Daylight 配布の監視を担当。
- レビュー担当: PR の質を担保するレビュワー。

### 例: 典型フロー

1. `feature/foo` を作成 → PR にてレビュー + CI → `beta` にマージ
2. 自動ビルドが走り、アーティファクトが生成される
3. 3 日ごとの Cron に差分があれば Daylight リリースを公開
4. サイクル最後に `beta` を `main` にマージ

---

この運用ルールは初期案です。実運用での問題点が分かれば逐次更新してください。

更新履歴:

- 2025-10-29: ドキュメント作成（長寿命 `beta` の運用方針）
