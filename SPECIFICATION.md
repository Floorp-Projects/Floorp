# Noraneko Browser Technical Guide

This document is a technical specification for the Noraneko Browser project. It was generated by an AI to help AI understand the codebase, but it is also designed to be clear and readable for humans.

## 1. Introduction to Noraneko Browser

Noraneko Browser is an experimental web browser project that serves as a testing ground for Floorp 12. It is built upon the Mozilla Firefox platform, using its core Gecko engine and internal tools.

A key goal for Noraneko is to improve upon the long build times often found in other Firefox-based browsers. By using the `mozbuild` system's artifact feature and modern front-end tools like Vite (as seen in `scripts/build.ts` and `scripts/defines.ts`), Noraneko allows for faster development. This means that changes to files like `.js`, `.ts`, or `.css` can be quickly updated in the browser through Hot Module Replacement (HMR) or by relaunching the browser, without needing to rebuild the entire browser. This approach aims to make development and testing more efficient.

**Current State:** Experimental
**License:** Mozilla Public License 2.0 (This license explains how the code can be used and shared.)

## 2. How Noraneko is Structured (Core Architecture)

Noraneko Browser's structure is closely tied to the Mozilla Firefox system. It uses many of Firefox's internal tools and components (for example, you can see this in `apps/modules/modules/NoranekoStartup.sys.mts`). This means Noraneko directly uses and adapts Firefox's main engine (Gecko) and its internal tools.

The project is organized into different main directories, such as `apps/modules`, `apps/features-about`, `apps/features-chrome`, `apps/settings`, and `apps/system` (these directories are visible when listing files in the `apps/` directory). Each of these directories is responsible for different browser features and user interface components.

## 3. Key Browser Capabilities (Features)

### 3.1. User Interface Customization

Noraneko Browser offers ways to customize its user interface and internal pages. This is managed through specific files (handled by `createDefaultUserChromeFiles` in `apps/modules/modules/NoranekoStartup.sys.mts`):

*   **`userChrome.css`**: This file allows developers to apply custom CSS rules to change the browser's main window appearance, including elements like buttons, tabs, and menus.
*   **`userContent.css`**: This file allows developers to apply custom CSS rules to the browser's internal pages, such as `about:newtab` (the new tab page) or `about:home` (the home page).

### 3.2. Custom Internal Pages

The browser registers several custom `about:` pages, providing tailored experiences for core functionalities (these are set up by `registerCustomAboutPages` and `getCustomAboutPages` in `apps/modules/modules/NoranekoStartup.sys.mts`):

*   **`about:hub`**: This page serves as a central area, likely for settings or a dashboard. Its content is loaded from `chrome://noraneko-settings/content/index.html`.
*   **`about:welcome`**: This page provides a welcome or onboarding screen, loading content from `chrome://noraneko-welcome/content/index.html`.
*   **`about:newtab` and `about:home`**: These pages are for the new tab and home page experiences. Both load content from `chrome://noraneko-newtab/content/index.html`.

### 3.3. Version Tracking

The browser includes logic to track its version, determining if it's a first-time installation or an update (implemented in `initializeVersionInfo` in `apps/modules/modules/NoranekoStartup.sys.mts`). This helps manage initial setup procedures or post-update actions.

## 4. Development Environment

Noraneko Browser uses Deno for its build and development workflows (as described in `README.md`), aiming for an efficient development experience:

*   **Build Command**: `deno task build` compiles the project to create the final program files.
*   **Development Command**: `deno task dev` is used for debugging. This command monitors file changes and updates the browser quickly (Hot Module Replacement, or HMR) without requiring a full browser rebuild.
*   **Local Test Server**: During development, the `about:newtab` page can load its content from a local development server at `http://localhost:5186/` (configured in `setupNoranekoNewTab` in `apps/modules/modules/NoranekoStartup.sys.mts`). This helps developers see UI changes immediately.
*   **Runtime Binaries**: Developers need `gh cli` (GitHub Command Line Interface) to download necessary runtime binaries from the `noraneko-runtime` GitHub repository (as detailed in `README.md`).

## 5. Project Influences (Inspirations and Dependencies)

Noraneko Browser is influenced by and incorporates elements from several established projects:

*   **Mozilla Firefox**: The foundational platform and rendering engine.
*   **Ablaze Floorp**: A significant inspiration, with Noraneko serving as a testbed for Floorp 12.
*   **Fushra Pulse**: Another browser project that has contributed ideas to Noraneko.
*   **Lepton Designs (Firefox-UI-Fix)**: This project has influenced Noraneko's visual design and user interface.

## 6. Automation and Build System (`scripts/`)

The `scripts/` directory acts as the central hub for all automation, build, development, and utility scripts within the Noraneko Browser project. It manages the entire development lifecycle, from preparing the environment and building the application to launching development servers and handling updates.

### 6.1. Core Build and Run (`scripts/build.ts`)

This is the main script responsible for orchestrating the build, development, and release processes. Its key functions include:

*   **Environment Setup**: Manages the setup of the binary directory (`runWithInitBinGit`), applies necessary git patches (`applyPatches`), generates version information (`genVersion`), and configures OS-specific environment variables (e.g., disabling content sandboxing for macOS development).
*   **Application Launch**: Provides functions (`run`) to start the browser in different modes (`dev`, `test`, `release`), launching the main browser process.
*   **Development Mode (`runDevMode`)**: Configures the development environment by creating symbolic links for various application components (features, modules, i18n) (`symlinkDirectory`), running child build processes, and starting a development server (likely Vite) with Hot Module Replacement (HMR) for rapid iteration. It also handles the injection of development-specific manifests (`injectManifest`) and XHTML content (`injectXHTMLDev`).
*   **Release Mode (`runReleaseMode`)**: Prepares the application for a production release, including running a production build, injecting release-specific manifests (`injectManifest`), and setting up final symbolic links for the distributable package (`symlinkDirectory`).
*   **Graceful Shutdown (`exit`)**: Ensures all child processes (browser and development server) are safely terminated, releasing resources.
*   **Production Build Orchestration (`buildForProduction`)**: Integrates with an external `mozbuild` system, handling steps before and after `mozbuild` packages the application, such as preparing files and performing final injections into the binary output (`injectXHTML`, `writeBuildid2`).

### 6.2. Definitions and Constants (`scripts/defines.ts`)

This file centralizes important constants and path definitions used across the build and development scripts. It includes:

*   **Branding Information**: Defines the base name (`brandingBaseName`) and display name (`brandingName`) of the Noraneko Browser.
*   **Version and Binary Paths**: Specifies paths for application binaries (`binDir`, `binPath`, `binPathExe`), version numbers (`binVersion`), build IDs (`buildid2Path`), and test profiles (`profileTestPath`), with adjustments for different operating systems (Windows, Linux, macOS).
*   **Module and Feature Paths**: Defines paths for loader features (`loaderFeaturesPath`), features-chrome (`featuresChromePath`), i18n features (`i18nFeaturesChromePath`), loader modules (`loaderModulesPath`), and main modules (`modulesPath`). These are important for the modular structure and how components are linked during development.
*   **Development Constants**: Contains strings for development server readiness (`devServerReadyString`) and branding suffixes (`devBrandingSuffix`).
*   **Build System Integration**: Defines the output directory for the `mozbuild` system (`mozbuildOutputDir`) and provides a utility function (`getBinArchive`) to determine the correct binary archive name based on the platform.

### 6.3. Logging Utility (`scripts/logger.ts`)

This file provides a simple logging system (`log` object) for the scripts, using `chalk` for colored console output. It supports `INFO`, `WARN`, and `ERROR` log levels (defined in `LogLevel` enum), which helps developers read and debug script output more easily.

### 6.4. General Utilities (`scripts/utils.ts`)

This file contains common helper functions used by various scripts, such as `isExists` for checking if a file or directory exists on the computer.

### 6.5. Subdirectories within `scripts/`

The `scripts/` directory is further organized into specialized subdirectories, each handling a specific part of the build or development process. These are often used by the main `scripts/build.ts` file:

*   **`scripts/cssUpdate/`**: Contains scripts related to updating or managing CSS styles, possibly for UI themes.
*   **`scripts/git-patches/`**: Manages special changes (git patches) that are applied to the core Mozilla/Floorp code that Noraneko uses.
*   **`scripts/inject/`**: This folder has tools that insert code and other assets directly into the browser's main files. This includes applying mixins (`applyMixin`), injecting manifest files (`injectManifest`), and modifying XHTML content (`injectXHTML`, `injectXHTMLDev`).
*   **`scripts/launchDev/`**: This folder holds scripts for starting and managing the development environment. This includes launching child processes for the browser and development server, saving preferences (`savePrefsForProfile`), and writing version information (`genVersion`), all managed by `scripts/build.ts`.
*   **`scripts/prepareDev/`**: This folder contains scripts for getting the development environment ready, such as decompressing downloaded browser files (`decompressBin`) and setting up the main browser directory (`initBin`), as used in `scripts/build.ts`.
*   **`scripts/update/`**: This folder includes scripts for managing browser updates, specifically related to build IDs (`writeBuildid2`) and version information, as integrated into `scripts/build.ts`.

## 7. Core Application System Components (`apps/system/`)

The `apps/system/` directory contains core system-level components and loaders that are essential for Noraneko Browser's modular design and startup process. These components are often linked or used by other parts of the application, especially during development and building, to integrate features and modules.

### 7.1. UI Feature Loaders (`apps/system/loader-features/`)

This directory is the main source for the browser's user interface (browser-chrome) features. It holds the basic code and resources for various UI parts and functions. During development and building, this directory is linked to `apps/features-chrome` (`featuresChromePath`) and `i18n/features-chrome` (`i18nFeaturesChromePath`). These links are made by `symlinkDirectory` calls in `scripts/build.ts`, and the paths are defined in `scripts/defines.ts`. This helps keep all UI code organized and easy to use across the browser.

### 7.2. Firefox System Module Loaders (`apps/system/loader-modules/`)

This directory is for special system modules (files ending in `.sys.mjs`) that come from the Firefox codebase. These modules are very important because they help the browser use advanced features like:

*   **JavaScript Actors (JSActors)**: These are like special agents that help different parts of the browser communicate.
*   **XPCOM Components**: These are parts of Firefox that help extend its abilities.
*   **Global Imports**: They allow other parts of the browser's UI to easily use code from these modules.

This system allows Noraneko to use Firefox's powerful way of organizing its internal parts for its main operations. This folder is linked to `apps/modules` (`modulesPath`) during development or building (as seen in `symlinkDirectory` calls in `scripts/build.ts` and defined in `scripts/defines.ts`).

### 7.3. Browser Startup Components (`apps/system/startup/`)

This directory contains code that is not processed by Vite (a fast web tool). Its main job is to load `loader-features` into the browser's main window (chrome). This helps enable modern JavaScript modules (ESM) to be used directly in the Firefox browser-chrome environment, which is usually difficult to time correctly in Firefox.

Because of how it loads (as shown in `scripts/inject/xhtml.ts`, where `chrome_root.js` is added to `browser.xhtml` with `async="async"`), this code might not always run before the user interface fully appears. This could lead to slight differences in startup speed compared to the original Firefox. This directory handles the first steps of loading and setting up important parts that connect the original Firefox system with Noraneko's custom features.
