require 'fileutils'
require 'securerandom'

module FelesBuild
  module DevEnvManager
    @logger = FelesBuild::Utils::Logger.new('dev-env')
    USER_JS = <<~JS
      /**
       *! DO NOT EDIT THIS FILE.
       *
       ** This file is AUTOGENERATED
       ** Please modify the 'scripts/launchBrowser/savePrefs.ts' in the repo.
       * https://github.com/nyanrus/noraneko
       */

      user_pref("devtools.debugger.prompt-connection",false);
      user_pref("security.disallow_privileged_https_script_loads", false);
      user_pref("security.allow_parent_unrestricted_js_loads", true);
      user_pref("remote.active-protocols", 1);
      user_pref("browser.newtabpage.enabled", true);
    JS

    def self.save_prefs(profile_dir)
      FileUtils.mkdir_p(profile_dir)
      path = File.join(profile_dir, 'user.js')
      File.write(path, USER_JS)
      @logger.success "user.js written to #{path}"
    end

    def self.write_dev_version_info
      root = File.expand_path('../../', __dir__)
      gecko = File.join(root, 'static/gecko')
      dist = File.join(root, '_dist')
      FileUtils.mkdir_p(dist)

      # From writeVersion.rb
      File.write(File.join(gecko, 'config/version.txt'), "version: 1.0.0\n")
      File.write(File.join(dist, 'buildid2.txt'), "buildid2: #{SecureRandom.uuid}\n")
      @logger.success "Wrote dev version info."
    end

    def self.setup
      # The profile dir is specified in the browser launcher as './_dist/profile/test'
      save_prefs('./_dist/profile/test')
      write_dev_version_info
    end
  end
end
