<!doctype html>
<title>popup helper</title>
<script>

const search = window.location.search.replace("?", "");
const steps = search.split("|");

while (steps.length) {
  const step = steps.shift();

  if (step.startsWith("report=")) {
    let bc = new BroadcastChannel(step.split("=")[1]);
    bc.postMessage({name: window.name });
    continue;
  }

  if (step === "close") {
    window.close();
    break;
  }

  if (step === "cross") {
    const url = new URL(window.location);
    url.host = "{{hosts[alt][]}}:{{ports[https][0]}}";
    url.search = "?" + steps.join("|");
    window.location = url.href;
    break;
  }

  if (step === "same") {
    const url = new URL(window.location);
    url.host = "{{host}}:{{ports[https][0]}}";
    url.search = "?" + steps.join("|");
    window.location = url.href;
    break;
  }

  if (step.startsWith("set=")) {
    window.name = step.split("=")[1];
    continue;
  }

  throw new Error("Unsupported step!");
}

</script>
