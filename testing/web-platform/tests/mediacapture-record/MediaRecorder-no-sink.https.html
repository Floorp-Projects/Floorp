<!doctype html>
<html>
<meta name="timeout" content="long">

<head>
  <title>MediaRecorder peer connection</title>
  <link rel="help"
        href="https://w3c.github.io/mediacapture-record/MediaRecorder.html#dom-mediarecorder-mimeType">
  <script src="/resources/testharness.js"></script>
  <script src="/resources/testharnessreport.js"></script>
  <script src="utils/peerconnection.js"></script>
</head>

<body>
  <script>

[{audio: true, video: false},
 {audio: false, video: true},
 {audio: true, video: true}].forEach(kind => {
  promise_test(async t => {
    const [localPc, remotePc, stream] = await startConnection(
        t, kind.audio, kind.video);
    const recorder = new MediaRecorder(stream);
    // Set an arbitrary timeslice interval so the ondataavailable event
    // handler gets invoked repeatedly so this test doesn't hang.
    recorder.start(200);
    let combinedSize = 0;
    // Wait for an arbitrary amount of data to appear before we resolve.
    // Keep it small for android tests
    while (combinedSize < 2000) {
      const {data} = await new Promise(r => recorder.ondataavailable = r);
      combinedSize += data.size;
    }
    recorder.stop();
  }, "PeerConnection MediaRecorder records " + JSON.stringify(kind) +
     " from PeerConnection without sinks");
});

  </script>
</body>

</html>
