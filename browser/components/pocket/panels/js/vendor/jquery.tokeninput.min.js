/*
 * Licensed under the MIT license.
 * http://loopj.com/jquery-tokeninput/
 */

(function(e){var c={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,scrollKeyboard:false,hintText:null,noResultsText:null,noResultsHideDropdown:false,searchingText:null,deleteText:"&times;",animateDropdown:true,emptyInputLength:null,tokenLimit:null,tokenDelimiter:",",preventDuplicates:false,tokenValue:"id",prePopulate:null,processPrePopulate:false,idPrefix:"token-input-",resultsFormatter:function(g){return"<li>"+g[this.propertyToSearch]+"</li>"},tokenFormatter:function(g){return"<li><p>"+g[this.propertyToSearch]+"</p></li>"},validateItem:null,noHoverSelect:false,onResult:null,onAdd:null,onDelete:null,onReady:null};var f={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"};var d={BEFORE:0,AFTER:1,END:2};var a={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};var b={init:function(g,h){var i=e.extend({},c,h||{});return this.each(function(){e(this).data("tokenInputObject",new e.TokenList(this,g,i))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(g){this.data("tokenInputObject").add(g);return this},remove:function(g){this.data("tokenInputObject").remove(g);return this},get:function(){return this.data("tokenInputObject").getTokens()}};e.fn.tokenInput=function(g){if(b[g]){return b[g].apply(this,Array.prototype.slice.call(arguments,1))}else{return b.init.apply(this,arguments)}};e.TokenList=function(i,t,R){if(e.type(t)==="string"||e.type(t)==="function"){R.url=t;var n=y();if(R.crossDomain===undefined){if(n.indexOf("://")===-1){R.crossDomain=false}else{R.crossDomain=(location.href.split(/\/+/g)[1]!==n.split(/\/+/g)[1])}}}else{if(typeof(t)==="object"){R.local_data=t}}if(R.classes){R.classes=e.extend({},f,R.classes)}else{if(R.theme){R.classes={};e.each(f,function(W,X){R.classes[W]=X+"-"+R.theme})}else{R.classes=f}}var F=[];var w=0;var s=new e.TokenList.Cache();var P;var M;function j(){var W=e(O).data("tokeninput");if(!W&&R.textToData){W=R.textToData(A.val())}if(W){L(W);E.change();return false}}var A=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",R.idPrefix+i.id).focus(function(){if(R.minChars==0){setTimeout(function(){C()},5)}if(R.tokenLimit===null||R.tokenLimit!==w){m()}}).blur(function(){j();G();e(this).val("")}).bind("keyup keydown blur update",g).keydown(function(X){var Z;var W;switch(X.keyCode){case a.LEFT:case a.RIGHT:case a.UP:case a.DOWN:if(!e(this).val()){Z=o.prev();W=o.next();if((Z.length&&Z.get(0)===D)||(W.length&&W.get(0)===D)){if(X.keyCode===a.LEFT||X.keyCode===a.UP){J(e(D),d.BEFORE)}else{J(e(D),d.AFTER)}}else{if((X.keyCode===a.LEFT||X.keyCode===a.UP)&&Z.length){S(e(Z.get(0)))}else{if((X.keyCode===a.RIGHT||X.keyCode===a.DOWN)&&W.length){S(e(W.get(0)))}}}}else{if(X.keyCode===a.UP||X.keyCode===a.DOWN){var Y=null;if(!O&&(X.keyCode===a.DOWN)){Y=e(".token-input-dropdown li").first()}else{if(X.keyCode===a.DOWN){Y=e(O).next()}else{Y=e(O).prev()}}if(Y.length){V(Y,true)}else{if(!(X.keyCode===a.DOWN)&&e(O).length){h(e(O))}}return false}}break;case a.BACKSPACE:Z=o.prev();if(!e(this).val().length){if(D){l(e(D));E.change()}else{if(Z.length){S(e(Z.get(0)))}}return false}else{if(e(this).val().length===1){G()}else{setTimeout(function(){C()},5)}}break;case a.TAB:case a.ENTER:case a.NUMPAD_ENTER:case a.COMMA:if(X.keyCode!=a.ENTER&&X.keyCode!=a.NUMPAD_ENTER){X.preventDefault()}j();break;case a.ESCAPE:G();return true;default:if(String.fromCharCode(X.which)){setTimeout(function(){C()},5)}break}});var E=e(i).hide().val("").focus(function(){A.focus()}).blur(function(){A.blur()});var D=null;var H=0;var O=null;var q=e("<ul />").addClass(R.classes.tokenList).click(function(X){var W=e(X.target).closest("li");if(W&&W.get(0)&&e.data(W.get(0),"tokeninput")){U(W)}else{if(D){J(e(D),d.END)}A.focus()}}).mouseover(function(X){var W=e(X.target).closest("li");if(W&&D!==this){W.addClass(R.classes.highlightedToken)}}).mouseout(function(X){var W=e(X.target).closest("li");if(W&&D!==this){W.removeClass(R.classes.highlightedToken)}}).insertBefore(E);var o=e("<li />").addClass(R.classes.inputToken).appendTo(q).append(A);var T=e("<div>").addClass(R.classes.dropdown).appendTo("body").hide();var K=e("<tester/>").insertAfter(A).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:A.css("fontSize"),fontFamily:A.css("fontFamily"),fontWeight:A.css("fontWeight"),letterSpacing:A.css("letterSpacing"),whiteSpace:"nowrap"});E.val("");var z=R.prePopulate||E.data("pre");if(R.processPrePopulate&&e.isFunction(R.onResult)){z=R.onResult.call(E,z)}if(z&&z.length){e.each(z,function(W,X){k(X);I()})}if(e.isFunction(R.onReady)){R.onReady.call();if(R.minChars==0){setTimeout(function(){C()},5)}}this.clear=function(){q.children("li").each(function(){if(e(this).children("input").length===0){l(e(this))}})};this.add=function(W){L(W)};this.remove=function(W){q.children("li").each(function(){if(e(this).children("input").length===0){var Z=e(this).data("tokeninput");var X=true;for(var Y in W){if(W[Y]!==Z[Y]){X=false;break}}if(X){l(e(this))}}})};this.getTokens=function(){return F};function I(){if(R.tokenLimit!==null&&w>=R.tokenLimit){A.hide();G();return}}function g(){if(M===(M=A.val())){return}var W=M.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");K.html(W);var X=30;if(R.emptyInputLength&&q.children().length<2){X=R.emptyInputLength}A.width(K.width()+X)}function Q(W){return((W>=48&&W<=90)||(W>=96&&W<=111)||(W>=186&&W<=192)||(W>=219&&W<=222))}function k(W){var Y=R.tokenFormatter(W);Y=e(Y).addClass(R.classes.token).insertBefore(o);e("<span>"+R.deleteText+"</span>").addClass(R.classes.tokenDelete).appendTo(Y).click(function(){l(e(this).parent());E.change();return false});var X={id:W.id};X[R.propertyToSearch]=W[R.propertyToSearch];X.item=W;e.data(Y.get(0),"tokeninput",W);F=F.slice(0,H).concat([X]).concat(F.slice(H));H++;x(F,E);w+=1;if(R.tokenLimit!==null&&w>=R.tokenLimit){A.hide();G()}return Y}function L(W){if(!W){return}if(e.isFunction(R.validateItem)&&!R.validateItem(W)){return false}var Y=R.onAdd;if(w>0&&R.preventDuplicates){var X=null;q.children().each(function(){var aa=e(this);var Z=e.data(aa.get(0),"tokeninput");if(Z&&Z.id===W.id){X=aa;return false}});if(X){S(X);o.insertAfter(X);A.focus();return}}if(R.tokenLimit==null||w<R.tokenLimit){k(W);I()}A.val("");G();if(e.isFunction(Y)){Y.call(E,W)}}function S(W){W.addClass(R.classes.selectedToken);D=W.get(0);A.val("");G()}function J(X,W){X.removeClass(R.classes.selectedToken);D=null;if(W===d.BEFORE){o.insertBefore(X);H--}else{if(W===d.AFTER){o.insertAfter(X);H++}else{o.appendTo(q);H=w}}A.focus()}function U(X){var W=D;if(D){J(e(D),d.END)}if(W===X.get(0)){J(X,d.END)}else{S(X)}}function l(X){var Y=e.data(X.get(0),"tokeninput");var Z=R.onDelete;var W=X.prevAll().length;if(W>H){W--}X.remove();D=null;A.focus();F=F.slice(0,W).concat(F.slice(W+1));if(W<H){H--}x(F,E);w-=1;if(R.tokenLimit!==null){A.show().val("").focus()}if(e.isFunction(Z)){Z.call(E,Y)}}function x(Y,W){var X=e.map(Y,function(Z){return Z[R.tokenValue]});W.val(X.join(R.tokenDelimiter))}function G(){T.hide().empty();O=null}function r(){T.css({position:"absolute",top:e(q).offset().top+e(q).outerHeight(),left:e(q).offset().left,zindex:999}).show()}function p(){if(R.searchingText){T.html("<p>"+R.searchingText+"</p>");r()}}function m(){if(R.hintText){T.html("<p>"+R.hintText+"</p>");r()}}function v(X,W){return X.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+W+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function B(X,Y,W){return X.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+Y+")(?![^<>]*>)(?![^&;]+;)","g"),v(Y,W))}function N(Y,W){if(W&&W.length){T.empty();var X=e("<ul>").appendTo(T).mouseover(function(Z){V(e(Z.target).closest("li"))}).mousedown(function(Z){L(e(Z.target).closest("li").data("tokeninput"));E.change();return false}).hide();if(R.noHoverSelect){X.off("mouseover");X.on("mouseover",function(Z){e(this).find("li").removeClass(R.classes.selectedDropdownItem);e(Z.target).closest("li").addClass(R.classes.selectedDropdownItem)})}e.each(W,function(Z,aa){var ab=R.resultsFormatter(aa);ab=e(ab).appendTo(X);if(Z%2){ab.addClass(R.classes.dropdownItem)}else{ab.addClass(R.classes.dropdownItem2)}e.data(ab.get(0),"tokeninput",aa)});r();if(R.animateDropdown){X.slideDown("fast")}else{X.show()}}else{if(R.noResultsText){T.html("<p>"+R.noResultsText+"</p>");r()}if(R.noResultsHideDropdown){G()}}}function V(aa,Z){if(aa){if(O){h(e(O))}if(R.scrollKeyboard&&Z){var ac=e(".token-input-dropdown-tag ul");var Y=ac.height();var W=aa.outerHeight();var ab=aa.position().top;if(ab>Y){var X=ac.scrollTop();ac.scrollTop(X+W)}else{if(ab<0){var X=ac.scrollTop();ac.scrollTop(X-W)}}}aa.addClass(R.classes.selectedDropdownItem);O=aa.get(0)}}function h(W){W.removeClass(R.classes.selectedDropdownItem);O=null}function C(){var W=A.val().toLowerCase();if(W&&W.length||R.minChars==0){if(D){J(e(D),d.AFTER)}if(W.length>=R.minChars){p();clearTimeout(P);P=setTimeout(function(){u(W)},R.searchDelay)}else{G()}}}function u(ac){var Y=ac+y();var W=s.get(Y);if(W){N(ac,W)}else{if(R.url){var aa=y();var Z={};Z.data={};if(aa.indexOf("?")>-1){var ad=aa.split("?");Z.url=ad[0];var X=ad[1].split("&");e.each(X,function(ae,ag){var af=ag.split("=");Z.data[af[0]]=af[1]})}else{Z.url=aa}Z.data[R.queryParam]=ac;Z.type=R.method;Z.dataType=R.contentType;if(R.crossDomain){Z.dataType="jsonp"}Z.success=function(ae){if(e.isFunction(R.onResult)){ae=R.onResult.call(E,ae)}s.add(Y,R.jsonContainer?ae[R.jsonContainer]:ae);if(A.val().toLowerCase()===ac){N(ac,R.jsonContainer?ae[R.jsonContainer]:ae)}};e.ajax(Z)}else{if(R.search_function){R.search_function(ac,function(ae){s.add(Y,ae);N(ac,ae)})}else{if(R.local_data){var ab=e.grep(R.local_data,function(ae){return ae[R.propertyToSearch].toLowerCase().indexOf(ac.toLowerCase())>-1});if(e.isFunction(R.onResult)){ab=R.onResult.call(E,ab)}s.add(Y,ab);N(ac,ab)}}}}}function y(){var W=R.url;if(typeof R.url=="function"){W=R.url.call()}return W}};e.TokenList.Cache=function(h){var j=e.extend({max_size:500},h);var k={};var i=0;var g=function(){k={};i=0};this.add=function(m,l){if(i>j.max_size){g()}if(!k[m]){i+=1}k[m]=l};this.get=function(l){return k[l]}}}(jQuery));