<!DOCTYPE html>
<meta charset="utf8">
<script src="shared_test_funcs.js"></script>
<script>
var popup;
window.addEventListener("load", async function listener(event) {
  let s = `
    window.addEventListener('message', async function listener(event) {
      if (event.data[0] == 'popup_is_ready') {
        window.opener.postMessage(["popup_ready"], "*");
      } else if (event.data[0] == 'popup_request') {
        let result = {
          hardwareConcurrency : navigator.hardwareConcurrency
        };
        window.opener.postMessage(['popup_response', result], '*');
      }
    });`;

  popup = window.open("about:blank", "");
  popup.eval(s);
});

async function runTheTest(iframe_domain, cross_origin_domain, mode) {
  popup.postMessage(["popup_is_ready", cross_origin_domain], "*");
  await waitForMessage("popup_ready", `*`);

  const promiseForRFPTest = new Promise(resolve => {
    window.addEventListener("message", event => {
      resolve(event.data[1]);
    }, { once: true });
  });

  popup.postMessage(["popup_request", cross_origin_domain], "*");
  var result = await promiseForRFPTest;

  popup.close();

  return result;
}

</script>
<output id="result"></output>
