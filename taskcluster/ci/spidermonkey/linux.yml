# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
---
job-defaults:
    worker:
        max-run-time: 36000
        docker-image: {in-tree: debian10-amd64-build}
        env:
            MOZ_JS_UPLOAD_BINARIES_DEFAULT: "0"
    run:
        tooltool-downloads: public

sm-package-linux64/opt:
    description: "Spidermonkey source package and test"
    index:
        job-name: sm-package-linux64-opt
    treeherder:
        symbol: SM(pkg)
        platform: linux64/opt
    run:
        using: spidermonkey-package
        spidermonkey-variant: plain
    fetches:
        toolchain:
            - linux64-clang
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-rust
            - linux64-gcc
            - linux64-sysroot

sm-plain-linux64/debug:
    description: "Spidermonkey Plain"
    index:
        job-name: sm-plain-linux64-debug
    treeherder:
        platform: linux64/debug
        symbol: SM(p)
    run:
        spidermonkey-variant: plaindebug
    fetches:
        toolchain:
            - linux64-clang
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-rust
            - linux64-sysroot

sm-plain-linux64/opt:
    description: "Spidermonkey Plain"
    index:
        job-name: sm-plain-linux64-opt
    treeherder:
        symbol: SM(p)
        platform: linux64/opt
    run:
        spidermonkey-variant: plain
    fetches:
        toolchain:
            - linux64-clang
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-rust
            - linux64-gcc
            - linux64-sysroot

sm-smoosh-linux64/debug:
    description: "Spidermonkey SmooshMonkey"
    index:
        job-name: sm-smoosh-linux64-debug
    treeherder:
        platform: linux64/debug
        symbol: SM(smoosh)
        tier: 3
    run:
        spidermonkey-variant: smooshdebug
    run-on-projects: ['mozilla-central']
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-smoosh-linux64/opt:
    description: "Spidermonkey SmooshMonkey"
    index:
        job-name: sm-smoosh-linux64-opt
    treeherder:
        symbol: SM(smoosh)
        platform: linux64/opt
        tier: 3
    run:
        spidermonkey-variant: smoosh
    run-on-projects: ['mozilla-central']
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-nojit-linux64/opt:
    description: "Spidermonkey no JIT"
    index:
        job-name: sm-nojit-linux64-opt
    treeherder:
        symbol: SM(nojit)
        platform: linux64/opt
    run:
        spidermonkey-variant: nojit
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-plain-linux32/debug:
    description: "Spidermonkey Plain"
    index:
        job-name: sm-plain-linux32-debug
    treeherder:
        platform: linux32/debug
        symbol: SM(p)
    run:
        spidermonkey-variant: plaindebug
        spidermonkey-platform: linux
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux32-sysroot

sm-arm-sim-linux32/debug:
    description: "Spidermonkey ARM sim"
    index:
        job-name: sm-arm-sim-linux32-debug
    treeherder:
        platform: linux32/debug
        symbol: SM(arm)
    run:
        spidermonkey-variant: arm-sim
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux32-sysroot

sm-arm64-sim-linux64/debug:
    description: "Spidermonkey ARM64 sim"
    index:
        job-name: sm-arm64-sim-linux64-debug
    treeherder:
        platform: linux64/debug
        symbol: SM(arm64)
    run:
        spidermonkey-variant: arm64-sim
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-arm64-sim-cranelift-linux64/debug:
    description: "Spidermonkey ARM64 sim with Cranelift Wasm backend"
    index:
        job-name: sm-arm64-sim-cranelift-linux64-debug
    treeherder:
        platform: linux64/debug
        symbol: SM(arm64cl)
        tier: 3
    run:
        spidermonkey-variant: arm64-cranelift-sim
    run-on-projects: ['mozilla-central']
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot
    routes:
        - "notify.email.jseward@mozilla.com.on-failed"
        - "notify.email.lhansen@mozilla.com.on-failed"

sm-asan-linux64/opt:
    description: "Spidermonkey Address Sanitizer"
    index:
        job-name: sm-asan-linux64-opt
    treeherder:
        symbol: SM(asan)
        platform: linux64/opt
    worker:
        env:
            MOZ_JS_UPLOAD_BINARIES_DEFAULT: "1"
    run:
        spidermonkey-variant: asan
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-compacting-linux64/debug:
    description: "Spidermonkey Compacting"
    index:
        job-name: sm-compacting-linux64-debug
    treeherder:
        platform: linux64/debug
        symbol: SM(cgc)
    run:
        spidermonkey-variant: compacting
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-msan-linux64/opt:
    description: "Spidermonkey Memory Sanitizer"
    index:
        job-name: sm-msan-linux64-opt
    treeherder:
        symbol: SM(msan)
        platform: linux64/opt
        tier: 3
    worker:
        env:
            MOZ_JS_UPLOAD_BINARIES_DEFAULT: "1"
    run:
        spidermonkey-variant: msan
    # Disable by default by allow try pushes to explicitly request.
    run-on-projects: []
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-tsan-linux64/opt:
    description: "Spidermonkey Thread Sanitizer"
    index:
        job-name: sm-tsan-linux64-opt
    treeherder:
        symbol: SM(tsan)
        platform: linux64/opt
    worker:
        env:
            MOZ_JS_UPLOAD_BINARIES_DEFAULT: "1"
    run:
        spidermonkey-variant: tsan
    fetches:
        toolchain:
            - linux64-clang
            - linux64-gcc
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-rust-nightly
            - linux64-sysroot

sm-rootanalysis-linux64/debug:
    description: "Spidermonkey Root Analysis"
    index:
        job-name: sm-rootanalysis-linux64-debug
    treeherder:
        platform: linux64/debug
        symbol: SM(r)
    run:
        spidermonkey-variant: rootanalysis
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-nonunified-linux64/debug:
    description: "Spidermonkey Non-Unified Debug"
    index:
        job-name: sm-nonunified-linux64-debug
    treeherder:
        platform: linux64/debug
        symbol: SM(nu)
    run:
        spidermonkey-variant: nonunified
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-fuzzing-linux64/opt:
    description: "Spidermonkey Fuzzing"
    index:
        job-name: sm-fuzzing-linux64
    treeherder:
        platform: linux64/opt
        symbol: SM(f)
    worker:
        env:
            MOZ_JS_UPLOAD_BINARIES_DEFAULT: "1"
    run:
        spidermonkey-variant: fuzzing
    fetches:
        toolchain:
            - linux64-clang
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot

sm-gdb-linux64/debug:
    description: "Spidermonkey GDB Pretty-printers"
    index:
        job-name: sm-gdb-linux64
    worker:
        docker-image: {in-tree: gdb-test}
    treeherder:
        platform: linux64/debug
        tier: 2
        symbol: SM(gdb)
    run:
        spidermonkey-variant: gdb
    fetches:
        toolchain:
            - linux64-clang
            - linux64-gcc
            - linux64-rust
            - linux64-cbindgen
            - linux64-dump-syms
            - linux64-breakpad-injector
            - linux64-minidump-stackwalk
            - linux64-llvm-symbolizer
            - linux64-sysroot
