# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
---
job-defaults:
    unpack: true
    fail-on-diff: true
    pre-diff-commands:
        # Remove noise from differences in line numbers in preprocessor output
        # due to #if/#else branches.
        - sed -i '/^\/\/@line /d' {a,b}/"$RESOURCE_DIR"/browser/defaults/preferences/firefox.js
        # bug 1825141 - telemetry.fog.artifact_build isn't stable between
        # artifact and not-artifact builds, so remove its line if present.
        - sed -i '/telemetry\.fog\.artifact\_build/d' b/"$RESOURCE_DIR"/browser/defaults/preferences/firefox.js
    # This is necessary to avoid building the dependencies on every push on autoland
    # A more robust fix for this is https://bugzilla.mozilla.org/show_bug.cgi?id=1643346
    optimization:
        skip-unless-expanded: null

artifact-win64-aarch64-eme-validation:
    symbol: DWE
    new: build-win64-aarch64-eme/opt
    original: build-win64-aarch64/opt
    pre-diff-commands:
        # The EME version has extra files under i686/.
        - rm -rf b/"$RESOURCE_DIR"/i686
        # Removing media.gmp-widevinecdm.* preferences, and setting
        # browser.eme.ui.enabled to false should give us the same preferences as
        # the non-EME build.
        - sed -i '/browser\.eme\.ui\.enabled/s/true/false/;/media\.gmp-widevinecdm\./d' b/"$RESOURCE_DIR"/browser/defaults/preferences/firefox.js
    # Extra diffoscope arguments to account for:
    # - about:buildconfig being expectedly different.
    # - There are some differences in PE metadata in helper.exe because
    #   it's (re)built in the EME build, and that part of the build is
    #   not reproducible.
    extra-args: >-
        --exclude-directory-metadata=recursive
        --exclude b/"$RESOURCE_DIR"/chrome/toolkit/content/global/buildconfig.html
        --exclude b/"$RESOURCE_DIR"/uninstall/helper.exe
