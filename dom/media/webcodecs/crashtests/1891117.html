<!DOCTYPE html>
<script>
function createFrame(width, height, timestamp) {
  let duration = 33333; // 30fps
  let cnv = new OffscreenCanvas(width, height);
  let ctx = cnv.getContext("2d");
  ctx.fillStyle = "#FF0000";
  ctx.fillRect(0, 0, width, height);
  return new VideoFrame(cnv, { timestamp, duration });
}

document.addEventListener("DOMContentLoaded", async () => {
  let callbacks = { error: (e) => {} };
  let gotOutput = new Promise(
    (resolve) => (callbacks.output = (chunk, metadata) => {
      resolve([metadata.decoderConfig, chunk]);
    }));
  const encoder = new VideoEncoder({
    output: callbacks.output,
    error: callbacks.error,
  });
  encoder.configure({
    codec: "vp8",
    width: 640,
    height: 480,
    displayWidth: 640,
    displayHeight: 480,
  });
  encoder.encode(createFrame(640, 480, 0));
  let [decoderConfig, chunk] = await gotOutput;

  const decoder = new VideoDecoder({
    output: (frame) => { frame.close(); },
    error: (e) => {},
  });
  decoder.configure({ ...decoderConfig, optimizeForLatency: true });
  decoder.decode(chunk);
  decoder.decode(
    new EncodedVideoChunk({
      type: "key",
      timestamp: 1,
      data: new ArrayBuffer(0),
    }));
  decoder.configure({
    codec: "󠋚᩿",
    width: 2147483648,
    height: 60,
  });
});
</script>
