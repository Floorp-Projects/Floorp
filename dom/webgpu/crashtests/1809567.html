<!DOCTYPE html>
<html class="reftest-wait">
  <body>
    <script>
      // We need to await things, so the bulk of the test is wrapped in an async
      // function.
      async function orphan_webgpu_device() {
          // Create an iframe in the same origin as this code.
          let iframe = document.createElement('iframe');
          document.body.appendChild(iframe);

          // Define a function in that iframe that creates a WebGPU
          // `GPUDevice`.
          let script = iframe.contentDocument.createElement('script');
          script.type = 'text/javascript';
          script.text = `
              async function create_device() {
                  let adapter = await navigator.gpu.requestAdapter({ });
                  return await adapter.requestDevice({ });
              }
          `;
          iframe.contentDocument.body.appendChild(script);

          // Call that function to create a `GPUDevice` in the iframe.
          let device = await iframe.contentWindow.create_device();

          // Remove the iframe from our document. This closes its window.
          iframe.remove();

          try {
              // When a Web API JavaScript object has had its parent window
              // closed, C++ implementations of its WebIDL methods become unable
              // to create JavaScript objects as usual: calling
              // `EventTarget::GetParentObject` returns `nullptr`.
              //
              // Since we removed `iframe` from this document, the following
              // call will fail trying to create a `Promise` of the module's
              // `GPUCompilationInfo`.
              device.createShaderModule({ code: '' });
          } catch (error) {
              // Eating errors indiscriminately wastes later developers' time.
              if (error.name != "NS_ERROR_UNEXPECTED") {
                  throw error;
              }
          }

          // End the crashtest.
          document.documentElement.removeAttribute("class");
      }

      orphan_webgpu_device();
    </script>
  </body>
</html>
