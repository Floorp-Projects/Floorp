<!DOCTYPE HTML>
<html>
<head>
  <title>Test for FileReader API</title>
  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
  <script type="text/javascript" src="common_fileReader.js"></script>
</head>

<body>
<script class="testbody" type="text/javascript">

const minFileSize = 20000;
SimpleTest.waitForExplicitFinish();

// Create strings containing data we'll test with. We'll want long
// strings to ensure they span multiple buffers while loading
var testTextData = "asd b\tlah\u1234w\u00a0r";
while (testTextData.length < minFileSize) {
  testTextData = testTextData + testTextData;
}

var testASCIIData = "abcdef 123456\n";
while (testASCIIData.length < minFileSize) {
  testASCIIData = testASCIIData + testASCIIData;
}

var testBinaryData = "";
for (var i = 0; i < 256; i++) {
  testBinaryData += String.fromCharCode(i);
}
while (testBinaryData.length < minFileSize) {
  testBinaryData = testBinaryData + testBinaryData;
}

var dataurldata0 = testBinaryData.substr(0, testBinaryData.length -
					 testBinaryData.length % 3);
var dataurldata1 = testBinaryData.substr(0, testBinaryData.length - 2 -
					 testBinaryData.length % 3);
var dataurldata2 = testBinaryData.substr(0, testBinaryData.length - 1 -
					 testBinaryData.length % 3);


//Set up files for testing
var openerURL = SimpleTest.getTestFileURL("fileapi_chromeScript.js");
var opener = SpecialPowers.loadChromeScript(openerURL);
opener.addMessageListener("files.opened", onFilesOpened);
opener.sendAsyncMessage("files.open", [
  testASCIIData,
  testBinaryData,
  null,
  convertToUTF8(testTextData),
  convertToUTF16(testTextData),
  "",
  dataurldata0,
  dataurldata1,
  dataurldata2,
]);

function onFilesOpened(message) {
  let [
    asciiFile,
    binaryFile,
    nonExistingFile,
    utf8TextFile,
    utf16TextFile,
    emptyFile,
    dataUrlFile0,
    dataUrlFile1,
    dataUrlFile2,
  ] = message;

  runTests(asciiFile, binaryFile, nonExistingFile, utf8TextFile, utf16TextFile,
           emptyFile, dataUrlFile0, dataUrlFile1, dataUrlFile2, testTextData)
  .then(SimpleTest.finish);
}

</script>
</body>
</html>
