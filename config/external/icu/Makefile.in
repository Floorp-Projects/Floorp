# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# Ensure that this happens before including rules.mk
ifdef USE_ICU
  ifndef MOZ_SYSTEM_ICU
    ifdef MOZ_ICU_DATA_ARCHIVE
      ICU_FILES += $(DEPTH)/intl/icu/target/data/out/$(ICU_DATA_FILE)
    endif
    ifdef ICU_FILES
      ICU_DEST := $(DIST)/bin
      INSTALL_TARGETS += ICU
      $(ICU_FILES): buildicu
     ICU_TARGET := target
    endif
  endif # !MOZ_SYSTEM_ICU
endif # USE_ICU

include $(topsrcdir)/config/rules.mk

ifdef USE_ICU
ifndef MOZ_SYSTEM_ICU
target:: buildicu
$(STATIC_LIBS): buildicu

# - Force ICU to use the standard suffix for object files because expandlibs
#   will discard all files with a non-standard suffix (bug 857450).
# - Options for genrb: -k strict parsing; -R omit collation tailoring rules.
buildicu::
# ICU's build system is full of races, so force non-parallel build.
# Msys screws up GENRBOPTS when it contains spaces, so all genrb flags need
# to be stuck together. See https://bugzilla.mozilla.org/show_bug.cgi?id=1034594#c34
ifdef CROSS_COMPILE
	+ASAN_OPTIONS=detect_leaks=0 $(MAKE) -j1 -C $(DEPTH)/intl/icu/host STATIC_O=$(OBJ_SUFFIX) GENRBOPTS='-kRC'
endif
	+ASAN_OPTIONS=detect_leaks=0 $(MAKE) -j1 -C $(DEPTH)/intl/icu/target STATIC_O=$(OBJ_SUFFIX) GENRBOPTS='-kR'

distclean clean::
ifdef CROSS_COMPILE
	+$(MAKE) -C $(DEPTH)/intl/icu/host $@ STATIC_O=$(OBJ_SUFFIX)
endif
	+$(MAKE) -C $(DEPTH)/intl/icu/target $@ STATIC_O=$(OBJ_SUFFIX)

endif
endif
