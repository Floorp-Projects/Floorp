# -*- Mode: python; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 40 -*-
# vim: set filetype=python:
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

if CONFIG['OS_ARCH'] == 'WINNT':
    error('should not reach here on Windows')

if CONFIG['MOZ_NATIVE_LIBEVENT']:
    error('should not reach here if we are using a native libevent')

os_macosx = 0
os_bsd = 0
os_linux = 0

if CONFIG['OS_ARCH'] == 'Darwin':
    os_macosx = 1
    libevent_include_suffix = 'mac'
elif CONFIG['OS_ARCH'] in ['DragonFly', 'FreeBSD', 'GNU_kFreeBSD',
                           'NetBSD', 'OpenBSD']:
    os_bsd = 1
    libevent_include_suffix = 'bsd'
else:
    os_linux = 1
    if CONFIG['OS_TARGET'] == 'Android':
        libevent_include_suffix = 'android'
    else:
        libevent_include_suffix = 'linux'

UNIFIED_SOURCES += [
    'libevent/buffer.c',
    'libevent/bufferevent.c',
    'libevent/bufferevent_ratelim.c',
    'libevent/bufferevent_sock.c',
    'libevent/event.c',
    'libevent/event_tagging.c',
    'libevent/evmap.c',
    'libevent/evrpc.c',
    'libevent/evthread.c',
    'libevent/evthread_pthread.c',
    'libevent/evutil.c',
    'libevent/evutil_rand.c',
    'libevent/http.c',
    'libevent/listener.c',
    'libevent/log.c',
    'libevent/poll.c',
    'libevent/select.c',
    'libevent/signal.c',
    'libevent/strlcpy.c',
]
SOURCES += [
    # This file cannot be built in unified mode because of strtotimeval
    # symbol clash.
    'libevent/evdns.c',
]
DEFINES['HAVE_CONFIG_H'] = True
LOCAL_INCLUDES += sorted([
    'libevent',
    'libevent/include',
    'libevent/' + libevent_include_suffix,
])

if os_macosx or os_bsd:
    UNIFIED_SOURCES += [
        'libevent/kqueue.c',
    ]

if os_linux:
    SOURCES += [
        'libevent/epoll.c',
    ]
    if CONFIG['OS_TARGET'] != 'Android':
        SOURCES += [
            'libevent/epoll_sub.c',
        ]

ALLOW_COMPILER_WARNINGS = True

FINAL_LIBRARY = 'xul'
