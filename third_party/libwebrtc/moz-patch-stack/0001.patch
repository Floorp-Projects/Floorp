From: Andreas Pehrson <apehrson@mozilla.com>
Date: Wed, 17 May 2023 14:41:47 +0200
Subject: (cherry-pick-branch-heads/5845) [M116] In
 VideoCaptureDS::{Start|Stop}Capture do not lock
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Sequence- and RaceCheckers ensure thread safety, and show that these
locks protect nothing.

(cherry picked from commit dcf600d7a5cdf8da51daf5b6f79df1de05002b13)

Bug: webrtc:15181, chromium:1457919
Change-Id: I7c26cd9aea5fa72ad9435de5ec1b9135ac22b1e8
Reviewed-on: https://webrtc-review.googlesource.com/c/src/+/305649
Reviewed-by: Ilya Nikolaevskiy <ilnik@webrtc.org>
Commit-Queue: Ilya Nikolaevskiy <ilnik@webrtc.org>
Reviewed-by: Per Kjellander <perkj@webrtc.org>
Cr-Original-Commit-Position: refs/heads/main@{#40345}
Reviewed-on: https://webrtc-review.googlesource.com/c/src/+/310520
Reviewed-by: Henrik Bostr√∂m <hbos@webrtc.org>
Cr-Commit-Position: refs/branch-heads/5845@{#3}
Cr-Branched-From: f80cf814353d11a9f22bef5ce5e8868f2c72f0d0-refs/heads/main@{#40319}
---
 modules/video_capture/windows/video_capture_ds.cc | 2 --
 1 file changed, 2 deletions(-)

diff --git a/modules/video_capture/windows/video_capture_ds.cc b/modules/video_capture/windows/video_capture_ds.cc
index acdf4004f6..37ee0fde01 100644
--- a/modules/video_capture/windows/video_capture_ds.cc
+++ b/modules/video_capture/windows/video_capture_ds.cc
@@ -125,7 +125,6 @@ int32_t VideoCaptureDS::Init(const char* deviceUniqueIdUTF8) {
 
 int32_t VideoCaptureDS::StartCapture(const VideoCaptureCapability& capability) {
   RTC_DCHECK_RUN_ON(&api_checker_);
-  MutexLock lock(&api_lock_);
 
   if (capability != _requestedCapability) {
     DisconnectGraph();
@@ -150,7 +149,6 @@ int32_t VideoCaptureDS::StartCapture(const VideoCaptureCapability& capability) {
 
 int32_t VideoCaptureDS::StopCapture() {
   RTC_DCHECK_RUN_ON(&api_checker_);
-  MutexLock lock(&api_lock_);
 
   HRESULT hr = _mediaControl->StopWhenReady();
   if (FAILED(hr)) {
-- 
2.34.1

