From: Jakob Ivarsson <jakobi@webrtc.org>
Date: Thu, 16 Feb 2023 17:21:20 +0100
Subject: (cherry-pick-branch-heads/5563) Disable stop CNG after a timeout.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This is still a behavior that we want, but a more careful rollout is needed.

(cherry picked from commit 48d784225972b7dd0542acfad7cd2d0eed25ad1c)

No-Try: True
Bug: webrtc:12790, chromium:1418687
Change-Id: Ic74c7b4945c0cdeda2b17f52301069424ad91162
Reviewed-on: https://webrtc-review.googlesource.com/c/src/+/293860
Commit-Queue: Jakob Ivarssonâ€Ž <jakobi@webrtc.org>
Reviewed-by: Henrik Lundin <henrik.lundin@webrtc.org>
Cr-Original-Commit-Position: refs/heads/main@{#39333}
Reviewed-on: https://webrtc-review.googlesource.com/c/src/+/294760
Reviewed-by: Alessio Bazzica <alessiob@webrtc.org>
Cr-Commit-Position: refs/branch-heads/5563@{#3}
Cr-Branched-From: 6c032cb8356b0d3f717c4fcf50796241f2bba6c2-refs/heads/main@{#39207}
---
 modules/audio_coding/neteq/decision_logic.h           | 2 +-
 modules/audio_coding/neteq/decision_logic_unittest.cc | 3 +++
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/modules/audio_coding/neteq/decision_logic.h b/modules/audio_coding/neteq/decision_logic.h
index 69b13a9048..8d1ff4d622 100644
--- a/modules/audio_coding/neteq/decision_logic.h
+++ b/modules/audio_coding/neteq/decision_logic.h
@@ -175,7 +175,7 @@ class DecisionLogic : public NetEqController {
     int reinit_after_expands = 100;
     int deceleration_target_level_offset_ms = 85;
     int packet_history_size_ms = 2000;
-    absl::optional<int> cng_timeout_ms = 1000;
+    absl::optional<int> cng_timeout_ms;
   };
   Config config_;
   std::unique_ptr<DelayManager> delay_manager_;
diff --git a/modules/audio_coding/neteq/decision_logic_unittest.cc b/modules/audio_coding/neteq/decision_logic_unittest.cc
index d0473d0264..6150c9a6db 100644
--- a/modules/audio_coding/neteq/decision_logic_unittest.cc
+++ b/modules/audio_coding/neteq/decision_logic_unittest.cc
@@ -18,6 +18,7 @@
 #include "modules/audio_coding/neteq/delay_manager.h"
 #include "modules/audio_coding/neteq/mock/mock_buffer_level_filter.h"
 #include "modules/audio_coding/neteq/mock/mock_delay_manager.h"
+#include "test/field_trial.h"
 #include "test/gtest.h"
 
 namespace webrtc {
@@ -53,6 +54,8 @@ using ::testing::Return;
 class DecisionLogicTest : public ::testing::Test {
  protected:
   DecisionLogicTest() {
+    test::ScopedFieldTrials trials(
+        "WebRTC-Audio-NetEqDecisionLogicConfig/cng_timeout_ms:1000/");
     NetEqController::Config config;
     config.tick_timer = &tick_timer_;
     config.allow_time_stretching = true;
-- 
2.34.1

