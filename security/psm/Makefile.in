#
# The contents of this file are subject to the Netscape Public
# License Version 1.1 (the "License"); you may not use this file
# except in compliance with the License. You may obtain a copy of
# the License at http://www.mozilla.org/NPL/
#
# Software distributed under the License is distributed on an "AS
# IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
# implied. See the License for the specific language governing
# rights and limitations under the License.
#
# The Original Code is mozilla.org code.
#
# The Initial Developer of the Original Code is Netscape
# Communications Corporation.  Portions created by Netscape are
# Copyright (C) 1998 Netscape Communications Corporation. All
# Rights Reserved.
#
# Contributor(s): 
#

DEPTH		= ../..
topsrcdir	= @top_srcdir@
srcdir		= @srcdir@
VPATH		= @srcdir@


CORE_DEPTH=$(topsrcdir)/security

include $(CORE_DEPTH)/coreconf/arch.mk
ifeq (,$(filter-out FreeBSD NetBSD OS2,$(OS_TARGET)))
include $(CORE_DEPTH)/coreconf/$(OS_TARGET).mk
else
include $(CORE_DEPTH)/coreconf/$(OS_CONFIG).mk
endif
include $(CORE_DEPTH)/coreconf/prefix.mk
ifeq ($(OS_ARCH),OS2)
CPU_TAG = _$(CC)
else
CPU_TAG = _$(CPU_ARCH)
endif
LOADABLE_ROOT_MODULE = $(DLL_PREFIX)nssckbi$(DLL_SUFFIX)
CORECONF_OBJDIR=$(OBJDIR_NAME)

include $(DEPTH)/config/autoconf.mk

ifndef MOZ_DEBUG
OPT_GMAKE_FLAGS = BUILD_OPT=1
BUILD_OPT=1
OBJDIR_TAG=_OPT
endif

DEFAULT_GMAKE_FLAGS = -f Makefile $(OPT_GMAKE_FLAGS) 

CORECONF_INSTALL     = $(DIST)/$(CORECONF_OBJDIR)
CORECONF_DIST        = $(MOZ_BUILD_ROOT)/dist/$(CORECONF_OBJDIR)
DEFAULT_GMAKE_FLAGS += DIST=$(CORECONF_DIST) 
DEFAULT_GMAKE_FLAGS += SOURCE_LIB_DIR=$(CORECONF_DIST)/lib
DEFAULT_GMAKE_FLAGS += SOURCE_BIN_DIR=$(CORECONF_DIST)/bin
DEFAULT_GMAKE_FLAGS += SOURCE_XP_DIR=$(CORECONF_DIST)


DIRS		= lib

include $(topsrcdir)/config/rules.mk

ABS_topsrcdir	:= $(shell cd $(topsrcdir); pwd)

install::
ifneq ($(ABS_topsrcdir),$(MOZ_BUILD_ROOT))
	if test ! -d $(MOZ_BUILD_ROOT)/security/nss; then                   \
		cp -r $(topsrcdir)/security/nss $(MOZ_BUILD_ROOT)/security; \
	fi;
	if test ! -d $(MOZ_BUILD_ROOT)/security/coreconf; then              \
		cp -r $(topsrcdir)/security/coreconf $(MOZ_BUILD_ROOT)/security; \
	fi;
	if test ! -d $(MOZ_BUILD_ROOT)/security/psm/server; then            \
		cp -r $(topsrcdir)/security/psm/server $(MOZ_BUILD_ROOT)/security/psm/server; \
	fi;
	if test ! -d $(MOZ_BUILD_ROOT)/security/psm/ui; then        \
		cp -r $(topsrcdir)/security/psm/ui $(MOZ_BUILD_ROOT)/security/psm/; \
	fi;
	if test ! -d $(MOZ_BUILD_ROOT)/security/psm/doc; then       \
		cp -r $(topsrcdir)/security/psm/doc $(MOZ_BUILD_ROOT)/security/psm/; \
	fi;
endif
	cd $(MOZ_BUILD_ROOT)/security/coreconf; $(MAKE) $(DEFAULT_GMAKE_FLAGS)
	cd $(MOZ_BUILD_ROOT)/security/nss; $(MAKE) $(DEFAULT_GMAKE_FLAGS) moz_import
	cd $(MOZ_BUILD_ROOT)/security/nss/lib; $(MAKE) $(DEFAULT_GMAKE_FLAGS)
	cd $(MOZ_BUILD_ROOT)/security/psm/ui; $(MAKE) $(DEFAULT_GMAKE_FLAGS)
	cd $(MOZ_BUILD_ROOT)/security/psm/server; $(MAKE) $(DEFAULT_GMAKE_FLAGS)
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psm$(PROG_SUFFIX) $(DIST)/bin
ifeq ($(OS_ARCH),OS2)
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/04digsgn.gif $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/06pcrypt.gif $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/bannerrn.gif $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/cartbanner.gif $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/cmcjavascriptapi.html $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/contents.htm $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/glossary.htm $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/help.htm $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/next.gif $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/prev.gif $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/psmtest.html $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/doc/release_notes.html $(DIST)/bin/psmdata/doc
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/ui/psm_bin.properties $(DIST)/bin/psmdata/ui
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/ui/psm_doc.properties $(DIST)/bin/psmdata/ui
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/ui/psm_text.properties $(DIST)/bin/psmdata/ui
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata/ui/psm_ui.properties $(DIST)/bin/psmdata/ui
else
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/psmdata $(DIST)/bin
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/bin/start-psm $(DIST)/bin
endif
	$(INSTALL) -m 755 $(CORECONF_INSTALL)/lib/$(LOADABLE_ROOT_MODULE) $(DIST)/bin

clean clobber clobber_all realclean distclean::
ifeq ($(ABS_topsrcdir),$(MOZ_BUILD_ROOT))
	cd $(MOZ_BUILD_ROOT)/security/coreconf; $(MAKE) $(DEFAULT_GMAKE_FLAGS) clean
	cd $(MOZ_BUILD_ROOT)/security/nss; $(MAKE) $(DEFAULT_GMAKE_FLAGS) clean
	cd $(MOZ_BUILD_ROOT)/security/psm/ui; $(MAKE) $(DEFAULT_GMAKE_FLAGS) clean
	cd $(MOZ_BUILD_ROOT)/security/psm/server; $(MAKE) $(DEFAULT_GMAKE_FLAGS) clean
else
	if test -d $(MOZ_BUILD_ROOT)/security/nss; then \
		rm -rf $(MOZ_BUILD_ROOT)/security/nss;  \
	fi;
	if test -d $(MOZ_BUILD_ROOT)/security/coreconf; then    \
		rm -rf $(MOZ_BUILD_ROOT)/security/coreconf;     \
	fi;
	if test -d $(MOZ_BUILD_ROOT)/security/psm/server; then  \
		rm -rf $(MOZ_BUILD_ROOT)/security/psm/server;   \
	fi;
	if test -d $(MOZ_BUILD_ROOT)/security/psm/ui; then      \
		rm -rf $(MOZ_BUILD_ROOT)/security/psm/ui;       \
	fi;
	if test -d $(MOZ_BUILD_ROOT)/security/psm/doc; then     \
		rm -rf $(MOZ_BUILD_ROOT)/security/psm/doc;      \
	fi;
	if test -d $(MOZ_BUILD_ROOT)/dist/$(CORECONF_OBJDIR); then      \
		rm -rf $(MOZ_BUILD_ROOT)/dist/$(CORECONF_OBJDIR);       \
	fi;
endif
