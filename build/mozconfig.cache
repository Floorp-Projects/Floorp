# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# Setup for build cache

# Thunderbird builds will have this set prior to including this file
aws_prefix=${aws_prefix:-taskcluster}

# builds without sccache disabled:
if test -z "$SCCACHE_DISABLE"; then

    if test -n "$TASKCLUSTER_WORKER_LOCATION" -a -x "$(command -v jq)"; then
        cloud=$(echo $TASKCLUSTER_WORKER_LOCATION | jq .cloud | tr -d \")
        case $cloud in
            aws|google)
                region=$(echo $TASKCLUSTER_WORKER_LOCATION | jq .region | tr -d \")
                ;;
        esac
    fi

    case $cloud in
    google)
        bucket=sccache-l${MOZ_SCM_LEVEL}-${region}
        ;;
    aws)
        bucket=${aws_prefix}-level-${MOZ_SCM_LEVEL}-sccache-${region}
        ;;
    esac

    if test -n "$bucket"; then
        if test "$cloud" = "google"; then
            mk_add_options "export SCCACHE_GCS_BUCKET=$bucket"
            mk_add_options "export SCCACHE_GCS_RW_MODE=READ_WRITE"
            mk_add_options "export SCCACHE_GCS_CREDENTIALS_URL=http://taskcluster/auth/v1/gcp/credentials/$SCCACHE_GCS_PROJECT/${bucket}@$SCCACHE_GCS_PROJECT.iam.gserviceaccount.com"
        else
            mk_add_options "export SCCACHE_BUCKET=$bucket"
            # instruct sccache to fetch the credentials from the Auth service's awsS3Credentials endpoint, via the Taskcluster proxy.
            mk_add_options "export AWS_IAM_CREDENTIALS_URL=http://taskcluster/auth/v1/aws/s3/read-write/${bucket}/?format=iam-role-compat"
        fi
        export CCACHE="$MOZ_FETCHES_DIR/sccache/sccache"
        export SCCACHE_VERBOSE_STATS=1
        mk_add_options MOZBUILD_MANAGE_SCCACHE_DAEMON=${MOZ_FETCHES_DIR}/sccache/sccache
    fi
fi

